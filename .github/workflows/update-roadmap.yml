name: Update Roadmap Table

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger
  issues:
    types: [opened, closed, reopened, labeled, unlabeled]
  pull_request:
    types: [opened, closed, reopened, labeled, unlabeled]

permissions:
  contents: write
  issues: read
  pull-requests: write

jobs:
  update-roadmap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch Issues and PRs
        id: fetch-data
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Feature mapping with search queries
            const features = [
              { priority: 'High', name: 'Publish `orbis-plugin-api` to crates.io', query: 'crates.io plugin-api in:title,body' },
              { priority: 'High', name: 'Deploy docs to GitHub Pages', query: 'docs github pages in:title,body' },
              { priority: 'High', name: 'Build & Release Tauri Binaries with auto-updates', query: 'tauri release auto-update in:title,body' },
              { priority: 'High', name: 'Automated Testing CI/CD', query: 'ci automated testing in:title,body' },
              { priority: 'High', name: 'Plugin Packages System', query: 'plugin packages in:title,body' },
              { priority: 'High', name: 'Pre-installed & Pre-enabled Plugins', query: 'pre-install plugins in:title,body' },
              { priority: 'High', name: 'Plugin Permissions & Graphical Modal', query: 'plugin permissions modal in:title,body' },
              { priority: 'High', name: 'Plugin Lockdown Mode', query: 'plugin lockdown in:title,body' },
              { priority: 'High', name: 'Non-removable & Non-disablable Plugins', query: 'system plugins in:title,body' },
              { priority: 'High', name: 'Plugin-to-Plugin IPC', query: 'inter-plugin ipc in:title,body' },
              { priority: 'High', name: 'Shared State Between Plugins', query: 'plugin shared state in:title,body' },
              { priority: 'High', name: 'Plugin Filesystem API', query: 'plugin filesystem in:title,body' },
              { priority: 'High', name: 'Full GUI Override Capability', query: 'gui override in:title,body' },
              { priority: 'High', name: 'Pest-based DSL for Page Definitions', query: 'pest dsl schema in:title,body' },
              { priority: 'High', name: 'Plugin Metadata DSL', query: 'metadata dsl in:title,body' },
              { priority: 'Medium', name: 'Remove Dead Plugin State Persistence Code', query: 'dead code state in:title,body' },
              { priority: 'Medium', name: 'Encrypted Data at Rest', query: 'encryption data in:title,body' },
              { priority: 'Medium', name: 'Encrypted Configuration Files', query: 'encrypted config in:title,body' },
              { priority: 'Medium', name: 'Hardcoded Default CLI Variables', query: 'cli defaults in:title,body' },
              { priority: 'Medium', name: 'Configuration Validation', query: 'config validation in:title,body' },
              { priority: 'Medium', name: 'Wire Up All Features in Default GUI', query: 'gui features in:title,body' },
              { priority: 'Medium', name: 'Fix Plugin Refresh Button', query: 'plugin refresh in:title,body' },
              { priority: 'Medium', name: 'Improved Plugin Loading Screen', query: 'plugin loading in:title,body' },
              { priority: 'Medium', name: 'Audit All Documentation', query: 'docs audit in:title,body' },
              { priority: 'Medium', name: 'Complete Missing Documentation', query: 'docs missing in:title,body' },
              { priority: 'Medium', name: 'Documentation for New Features', query: 'docs new features in:title,body' },
              { priority: 'Medium', name: 'Audit for Unused Code', query: 'unused code in:title,body' },
              { priority: 'Medium', name: 'Consolidate Duplicate Code', query: 'duplicate code in:title,body' },
              { priority: 'Medium', name: 'Implement Missing Runtime Functions', query: 'runtime functions in:title,body' },
              { priority: 'Medium', name: 'Add Comprehensive Tests', query: 'tests comprehensive in:title,body' },
              { priority: 'Medium', name: 'Error Handling Improvements', query: 'error handling in:title,body' },
              { priority: 'Medium', name: 'Renderer Performance Optimization', query: 'renderer performance in:title,body' },
              { priority: 'Medium', name: 'Database Performance', query: 'database performance in:title,body' },
              { priority: 'Medium', name: 'Security Audit', query: 'security audit in:title,body' },
              { priority: 'Medium', name: 'Dependency Security', query: 'dependency security in:title,body' },
              { priority: 'Medium', name: 'Secrets Management', query: 'secrets management in:title,body' },
              { priority: 'Low', name: 'Plugin Discovery & Marketplace', query: 'plugin marketplace in:title,body' },
              { priority: 'Low', name: 'Plugin Auto-updates', query: 'plugin updates in:title,body' },
              { priority: 'Low', name: 'Plugin Development Tools', query: 'plugin dev tools in:title,body' },
              { priority: 'Low', name: 'Analytics & Telemetry', query: 'analytics telemetry in:title,body' },
              { priority: 'Low', name: 'Internationalization (i18n)', query: 'i18n localization in:title,body' }
            ];

            const results = [];
            
            for (const feature of features) {
              try {
                // Search for issues
                const issuesResult = await github.rest.search.issuesAndPullRequests({
                  q: `${feature.query} repo:${context.repo.owner}/${context.repo.repo} is:issue`,
                  per_page: 5
                });
                
                // Search for PRs
                const prsResult = await github.rest.search.issuesAndPullRequests({
                  q: `${feature.query} repo:${context.repo.owner}/${context.repo.repo} is:pr`,
                  per_page: 5
                });
                
                const issues = issuesResult.data.items;
                const prs = prsResult.data.items;
                
                let status = 'Planned';
                let issueLinks = [];
                
                if (issues.length > 0 || prs.length > 0) {
                  // Determine status based on issue/PR states
                  const hasOpen = issues.some(i => i.state === 'open') || prs.some(p => p.state === 'open');
                  const hasClosed = issues.some(i => i.state === 'closed') || prs.some(p => p.state === 'closed' && p.pull_request?.merged_at);
                  
                  if (hasClosed && !hasOpen) {
                    status = 'Completed';
                  } else if (hasOpen) {
                    status = 'In Progress';
                  }
                  
                  // Create links
                  issues.slice(0, 3).forEach(issue => {
                    issueLinks.push(`[#${issue.number}](${issue.html_url})`);
                  });
                  
                  prs.slice(0, 3).forEach(pr => {
                    issueLinks.push(`[PR#${pr.number}](${pr.html_url})`);
                  });
                }
                
                const searchUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/issues?q=${encodeURIComponent(feature.query.replace(' in:title,body', ''))}`;
                const linksColumn = issueLinks.length > 0 
                  ? issueLinks.join(', ') + ` • [Search](${searchUrl})`
                  : `[Search](${searchUrl})`;
                
                results.push({
                  priority: feature.priority,
                  name: feature.name,
                  status: status,
                  links: linksColumn
                });
              } catch (error) {
                console.error(`Error processing feature "${feature.name}":`, error);
                results.push({
                  priority: feature.priority,
                  name: feature.name,
                  status: 'Planned',
                  links: `[Search](https://github.com/${context.repo.owner}/${context.repo.repo}/issues)`
                });
              }
            }
            
            // Generate markdown table
            let table = '| Priority | Feature | Status | Issues / PRs |\n';
            table += '| --- | --- | --- | --- |\n';
            
            for (const result of results) {
              table += `| **${result.priority}** | ${result.name} | ${result.status} | ${result.links} |\n`;
            }
            
            // Write to file for next step
            fs.writeFileSync('roadmap-table.md', table);
            
            return { success: true, rowCount: results.length };

      - name: Update Roadmap File
        run: |
          # Read the generated table
          TABLE_CONTENT=$(cat roadmap-table.md)
          
          # Update the roadmap.mdx file
          ROADMAP_FILE="docs/src/docs/roadmap.mdx"
          
          # Use awk to replace content between markers
          awk -v table="$TABLE_CONTENT" '
            /\{\/\* AUTO-GENERATED-TABLE-START \*\/\}/ { 
              print
              print ""
              print table
              print ""
              skip = 1
              next
            }
            /\{\/\* AUTO-GENERATED-TABLE-END \*\/\}/ {
              skip = 0
            }
            !skip
          ' "$ROADMAP_FILE" > "${ROADMAP_FILE}.tmp"
          
          mv "${ROADMAP_FILE}.tmp" "$ROADMAP_FILE"
          
          # Update the last update timestamp
          TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M UTC')
          sed -i "s/> \*\*Last Auto-Update\*\*:.*/> **Last Auto-Update**: $TIMESTAMP/" "$ROADMAP_FILE"

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code docs/src/docs/roadmap.mdx || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request if changed
        if: steps.git-check.outputs.changed == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update roadmap table with latest issue/PR data"
          committer: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
          branch: roadmap-auto-update
          delete-branch: true
          title: "Update Roadmap Table with Latest Issue/PR Data"
          body: |
            ## Automated Roadmap Update
            
            This PR updates the roadmap table with the latest status from GitHub issues and pull requests.
            
            ### Changes
            - Updated feature statuses based on open/closed issues and PRs
            - Added links to relevant issues and pull requests
            - Updated timestamp
            
            ### Summary
            - Total features tracked: 41
            - High priority: 15
            - Medium priority: 21
            - Low priority: 5
            
            This PR was automatically generated by the roadmap update workflow.
            
            **Review**: Check that all feature statuses are correct and links are working.
            
            **Auto-merge**: This PR is configured to auto-merge after status checks pass.
          labels: |
            documentation
            automated
          draft: false
          sign-commits: true

      - name: Enable Auto-Merge on PR
        if: steps.git-check.outputs.changed == 'true' && steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.create-pr.outputs.pull-request-number }};
            
            try {
              // Enable auto-merge with squash merge method
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_request_number: prNumber,
                event: 'APPROVE',
                body: 'Auto-approving automated roadmap update. All checks passed.'
              });
              
              console.log(`✅ Auto-approved PR #${prNumber}`);
              
              // Get the PR node ID for GraphQL mutation
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_request_number: prNumber
              });
              
              // Enable auto-merge via GraphQL
              await github.graphql(`
                mutation($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: $pullRequestId,
                    mergeMethod: SQUASH
                  }) {
                    pullRequest {
                      autoMergeRequest {
                        enabledAt
                      }
                    }
                  }
                }
              `, {
                pullRequestId: pr.node_id
              });
              
              console.log(`✅ Auto-merge enabled on PR #${prNumber}`);
            } catch (error) {
              console.error('Failed to enable auto-merge:', error);
              // Don't fail the workflow if auto-merge fails
              core.warning(`Could not enable auto-merge on PR #${prNumber}: ${error.message}`);
            }
            
